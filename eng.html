<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Vocab Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    .choice:hover {
      transform: translateY(-1px);
    }

    .fade-enter {
      opacity: 0;
      transform: translateY(6px);
    }

    .fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: all .25s ease;
    }

    .tag {
      font-variant-numeric: tabular-nums;
    }

    .video-background {
      position: fixed;
      /* ให้วางติดหน้าจอ */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* ให้ video เต็มจอพอดี */
      z-index: -1;
      /* ส่งไปอยู่ข้างหลังเนื้อหา */
    }

    .content {
      position: relative;
      z-index: 1;
      color: white;
      text-align: center;
      top: 40%;
      font-size: 2rem;
      font-family: Arial, sans-serif;
    }

    input[type="radio"].accent-black:checked {
      accent-color: green;
      /* เปลี่ยนเป็นสีที่ต้องการ */
    }

    .loader {
      animation: loaderAnimation 0.3s ease-in-out forwards;
    }

    @keyframes loaderAnimation {
      from {
        transform: translateY(30px);
        opacity: 0;
      }

      to {
        transform: translateY(0px);
        opacity: 100;
      }
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- วีดีโอพื้นหลัง -->
  <button id="play-sound">Enable Sound</button>
  <video id="bg-video" class="video-background" autoplay muted loop playsinline>
    <source src="./background-vid.mp4" type="video/mp4">
    เบราว์เซอร์ของคุณไม่รองรับ video tag
  </video>
  <div class="max-w-3xl mx-auto p-6 loader">
    <header class="flex items-center justify-between gap-4 mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">English Vocabulary Quiz <span
          class="text-gray-500 text-lg"></span></h1>
      <button id="resetBtnTop"
        class="hidden px-3 py-2 rounded-xl bg-gray-900 text-white text-sm font-semibold shadow-sm hover:opacity-90">เริ่มใหม่</button>
    </header>

    <!-- SETUP PANEL -->
    <section id="setupPanel" class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-5 space-y-5">
      <div>
        <label class="block text-sm font-semibold mb-2">เลือกระดับความยาก (Level)</label>
        <div class="flex flex-wrap gap-2">
          <label
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl ring-1 ring-gray-300 cursor-pointer hover:bg-gray-50">
            <input type="radio" name="level" value="Easy" class="accent-black" checked>
            <span class="font-medium">Easy (Starter)</span>
          </label>
          <label
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl ring-1 ring-gray-300 cursor-pointer bg-blue-100 hover:bg-blue-200">
            <input type="radio" name="level" value="Medium" class="accent-black">
            <span class="font-medium">Medium</span>
          </label>
          <label
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl ring-1 ring-gray-300 cursor-pointer bg-orange-100 hover:bg-orange-200">
            <input type="radio" name="level" value="Hard" class="accent-black">
            <span class="font-medium">Hard</span>
          </label>
          <label
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl ring-1 ring-gray-300 cursor-pointer bg-red-100 hover:bg-red-200">
            <input type="radio" name="level" value="VeryHard" class="accent-black">
            <span class="font-medium">Very hard</span>
          </label>
        </div>
      </div>

      <div class="grid sm:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="block text-sm font-semibold">โหมด (Mode)</label>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="mode" value="fixed" class="accent-black" checked>
              <span>กำหนดจำนวนข้อ (Fixed)</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="mode" value="endless" class="accent-black">
              <span>ตอบไปเรื่อย ๆ (ไม่จำกัดข้อ) — กดปุ่มจบเมื่อพร้อมดูผล (Endless)</span>
            </label>
          </div>
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-semibold">จำนวนข้อ (ใช้เมื่อเลือกโหมดกำหนดจำนวน)</label>
          <input id="questionCount" type="number" min="1" max="50" step="1" value="10"
            class="w-40 px-3 py-2 rounded-xl ring-1 ring-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white">
        </div>
      </div>

      <div class="flex items-center gap-3 pt-2">
        <button id="startBtn"
          class="px-4 py-2 rounded-xl bg-gray-900 text-white font-semibold shadow hover:opacity-90">เริ่มทำแบบทดสอบ</button>
        <p class="text-sm text-gray-600">เมื่อเริ่มแล้วจะมีคำศัพท์ภาษาอังกฤษขึ้นมา ให้เลือกความหมายภาษาไทย (4 ตัวเลือก)
        </p>
      </div>
    </section>

    <!-- QUIZ PANEL -->
    <section id="quizPanel" class="hidden mt-6 bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <span class="tag inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100">ระดับ: <span id="levelTag"
              class="font-semibold"></span></span>
          <span class="tag inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100">ข้อที่: <span id="qIndexTag"
              class="font-semibold">1</span></span>
          <span class="tag inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100">ถูก: <span id="scoreTag"
              class="font-semibold">0</span></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="stopBtn"
            class="px-3 py-2 rounded-xl bg-white ring-1 ring-gray-300 font-semibold hover:bg-gray-50">จบและดูผล</button>
          <button id="resetBtn"
            class="px-3 py-2 rounded-xl bg-gray-900 text-white font-semibold shadow hover:opacity-90">เริ่มใหม่</button>
        </div>
      </div>

      <div id="questionCard" class="fade-enter rounded-2xl border border-gray-200 p-6">
        <p class="text-sm text-gray-500 mb-1">เลือกความหมายที่ถูกต้อง</p>
        <h2 id="questionText" class="text-2xl font-extrabold tracking-tight mb-4">word</h2>

        <div id="choices" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>

        <p id="feedback" class="mt-4 text-sm font-semibold"></p>
      </div>
    </section>

    <!-- RESULT PANEL -->
    <section id="resultPanel" class="hidden mt-6 bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">สรุปผลแบบทดสอบ</h3>
        <button id="playAgainBtn"
          class="px-3 py-2 rounded-xl bg-gray-900 text-white font-semibold shadow hover:opacity-90">เล่นอีกครั้ง</button>
      </div>
      <div class="grid sm:grid-cols-3 gap-3 mb-4">
        <div class="rounded-xl bg-gray-50 p-3">
          <div class="text-sm text-gray-500">จำนวนข้อทั้งหมด</div>
          <div id="summaryTotal" class="text-2xl font-extrabold">0</div>
        </div>
        <div class="rounded-xl bg-gray-50 p-3">
          <div class="text-sm text-gray-500">ตอบถูก</div>
          <div id="summaryCorrect" class="text-2xl font-extrabold text-emerald-600">0</div>
        </div>
        <div class="rounded-xl bg-gray-50 p-3">
          <div class="text-sm text-gray-500">ความถูกต้อง</div>
          <div id="summaryScore" class="text-2xl font-extrabold">0%</div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">ข้อ</th>
              <th class="py-2 pr-4">คำศัพท์</th>
              <th class="py-2 pr-4">คำตอบของคุณ</th>
              <th class="py-2 pr-4">คำตอบที่ถูก</th>
              <th class="py-2 pr-4">ผลลัพธ์</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ===================== DATA =====================
    let WORDS = {}; // เก็บข้อมูลจาก JSON

    // โหลด words.json
    async function loadWords() {
      const res = await fetch('./ENGwords.json');
      WORDS = await res.json();
    }

    // เรียกใช้ฟังก์ชันให้โหลดคำศัพท์
    loadWords()

    // ===================== STATE =====================
    let state = {
      level: 'Easy',
      mode: 'endless', // 'endless' | 'fixed'
      totalQuestions: 10,
      asked: [], // indices already used (to avoid repeats in a round)
      score: 0,
      qIndex: 0, // number of questions shown so far
      current: null, // { w, t, choices:[], correctIndex }
      history: [] // { idx, word, correctTH, pickedTH, isCorrect }
    };

    // ===================== HELPERS =====================
    const $ = sel => document.querySelector(sel);
    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
    function sampleDifferent(levelArr, excludeIndex, k = 3) {
      // pick k distinct indices != excludeIndex
      const idxs = levelArr.map((_, i) => i).filter(i => i !== excludeIndex);
      shuffle(idxs);
      return idxs.slice(0, k);
    }
    function pickNextIndex(levelArr) {
      // if all used, reset asked in endless mode
      if (state.asked.length >= levelArr.length) state.asked = [];
      let tries = 0;
      while (tries < 1000) {
        const i = Math.floor(Math.random() * levelArr.length);
        if (!state.asked.includes(i)) return i;
        tries++;
      }
      return 0;
    }

    // ===================== RENDER =====================
    function setVisible(id, show) { const el = $(id); if (!el) return; el.classList.toggle('hidden', !show); }
    function updateTags() {
      $('#levelTag').textContent = state.level;
      $('#qIndexTag').textContent = String(state.qIndex + 1);
      $('#scoreTag').textContent = String(state.score);
    }

    function renderQuestion() {
      const q = state.current;
      if (!q) return;
      const qText = $('#questionText');
      qText.textContent = q.w;
      const feedback = $('#feedback');
      feedback.textContent = '';
      feedback.className = 'mt-4 text-sm font-semibold';

      const choicesWrap = $('#choices');
      choicesWrap.innerHTML = '';
      q.choices.forEach((choiceText, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice text-left w-full px-4 py-3 rounded-xl ring-1 ring-gray-300 hover:bg-gray-50 transition-all';
        btn.textContent = choiceText;
        btn.onclick = () => onPick(idx);
        choicesWrap.appendChild(btn);
      });

      // small enter animation
      const card = $('#questionCard');
      card.classList.remove('fade-enter');
      void card.offsetWidth; // reflow
      card.classList.add('fade-enter');
      requestAnimationFrame(() => card.classList.add('fade-enter-active'));

      updateTags();
    }

    //video background music button
    const btn = document.getElementById('play-sound');
    const video = document.getElementById('bg-video');

    btn.addEventListener('click', () => {
      if (video.muted == false) {
        video.muted = true;
        btn.textContent = "Enable Sound"
      }
      else {
        video.muted = false;
        btn.textContent = "Disable Sound"
      }
      video.play();          // เริ่มเล่นถ้ายังไม่เล่น
    });

    function prepareQuestion() {
      const levelArr = WORDS[state.level];
      const correctIdx = pickNextIndex(levelArr);
      state.asked.push(correctIdx);
      const distractorIdxs = sampleDifferent(levelArr, correctIdx, 3);
      const options = [levelArr[correctIdx].t, ...distractorIdxs.map(i => levelArr[i].t)];
      const shuffled = shuffle(options.slice());
      const correctIndex = shuffled.indexOf(levelArr[correctIdx].t);

      state.current = {
        w: levelArr[correctIdx].w,
        t: levelArr[correctIdx].t,
        choices: shuffled,
        correctIndex,
        poolIndex: correctIdx
      };
      renderQuestion();
    }
    const radios = document.querySelectorAll('input[name="mode"]');

    radios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.checked) {
          if (radio.value.trim() == "fixed") {
            document.getElementById('questionCount').classList.remove("cursor-not-allowed")
            document.getElementById('questionCount').disabled = false;
            document.getElementById('questionCount').classList.remove("bg-gray-300")
            document.getElementById('questionCount').classList.add("bg-white")
          }
          else {
            document.getElementById('questionCount').classList.add("cursor-not-allowed")
            document.getElementById('questionCount').disabled = true;
            document.getElementById('questionCount').classList.remove("bg-white")
            document.getElementById('questionCount').classList.add("bg-gray-300")
          }
        }
      });
    });

    function onPick(idx) {
      const isCorrect = idx === state.current.correctIndex;
      const buttons = Array.from(document.querySelectorAll('#choices .choice'));
      buttons.forEach((b, i) => {
        b.disabled = true;
        b.classList.add('cursor-not-allowed');
        if (i === state.current.correctIndex) {
          b.classList.remove('ring-gray-300');
          b.classList.add('ring-emerald-500');
        }
        if (i === idx && !isCorrect) {
          b.classList.remove('ring-gray-300');
          b.classList.add('ring-rose-500');
        }
      });

      const feedback = $('#feedback');
      if (isCorrect) {
        state.score++;
        feedback.textContent = 'ถูกต้อง!';
        feedback.classList.add('text-emerald-700');
      } else {
        feedback.textContent = `ผิด — คำตอบที่ถูกคือ “${state.current.t}”`;
        feedback.classList.add('text-rose-700');
      }

      state.history.push({
        idx: state.qIndex + 1,
        word: state.current.w,
        correctTH: state.current.t,
        pickedTH: state.current.choices[idx],
        isCorrect
      });

      // proceed automatically after a short delay
      setTimeout(() => {
        if (state.mode === 'fixed') {
          if (state.qIndex + 1 >= state.totalQuestions) {
            endQuiz();
            return;
          }
        }
        state.qIndex++;
        prepareQuestion();
      }, 1000);
    }

    function endQuiz() {
      setVisible('#quizPanel', false);
      setVisible('#resultPanel', true);
      // summary
      const total = state.history.length;
      const correct = state.history.filter(h => h.isCorrect).length;
      $('#summaryTotal').textContent = total;
      $('#summaryCorrect').textContent = correct;
      const pct = total ? Math.round((correct / total) * 100) : 0;
      $('#summaryScore').textContent = pct + '%';
      // table
      const tbody = $('#resultBody');
      tbody.innerHTML = '';
      state.history.forEach(h => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="py-2 pr-4">${h.idx}</td>
          <td class="py-2 pr-4 font-semibold">${h.word}</td>
          <td class="py-2 pr-4 ${h.isCorrect ? 'text-emerald-700' : 'text-rose-700'}">${h.pickedTH}</td>
          <td class="py-2 pr-4">${h.correctTH}</td>
          <td class="py-2 pr-4">${h.isCorrect ? '✔️' : '❌'}</td>
        `;
        tbody.appendChild(tr);
      });
      $('#resetBtnTop').classList.remove('hidden');
    }

    function resetAll(toSetup = true, keepSettings = true) {
      if (!keepSettings) {
        // ใช้ default ค่าเริ่มต้น
        state = { level: 'Easy', mode: 'fixed', totalQuestions: 10, asked: [], score: 0, qIndex: 0, current: null, history: [] };
        document.querySelector('input[name="level"][value="Easy"]').checked = true;
        document.querySelector('input[name="mode"][value="fixed"]').checked = true;
        $('#questionCount').value = 10;
      } else {
        // เก็บค่าเดิม
        state = {
          level: state.level,
          mode: state.mode,
          totalQuestions: state.totalQuestions,
          asked: [],
          score: 0,
          qIndex: 0,
          current: null,
          history: []
        };
        // UI ไม่ต้อง reset level/mode/value ให้มันยังคงค่าเดิม
      }

      setVisible('#setupPanel', toSetup);
      setVisible('#quizPanel', !toSetup && true);
      setVisible('#resultPanel', false);
      $('#resetBtnTop').classList.add('hidden');

      if (!toSetup) {
        updateTags();
        prepareQuestion();
      }
    }

    function startQuiz() {
      const levelSel = document.querySelector('input[name="level"]:checked');
      const modeSel = document.querySelector('input[name="mode"]:checked');
      state.level = levelSel ? levelSel.value : 'Easy';
      state.mode = modeSel ? modeSel.value : 'fixed';
      const n = parseInt($('#questionCount').value, 10);
      if (!Number.isFinite(n) || n < 1) state.totalQuestions = 10; else state.totalQuestions = Math.min(n, 50);

      state.asked = [];
      state.score = 0;
      state.qIndex = 0;
      state.history = [];

      setVisible('#setupPanel', false);
      setVisible('#quizPanel', true);
      setVisible('#resultPanel', false);
      updateTags();
      prepareQuestion();
    }

    // ===================== EVENTS =====================
    $('#startBtn').addEventListener('click', startQuiz);
    $('#stopBtn').addEventListener('click', endQuiz);
    $('#resetBtn').addEventListener('click', () => resetAll(true, false));
    $('#resetBtnTop').addEventListener('click', () => resetAll(true, false));
    $('#playAgainBtn').addEventListener('click', () => resetAll(false, true));

    // keyboard shortcuts: 1–4 to answer
    document.addEventListener('keydown', (e) => {
      if (!$('#quizPanel') || $('#quizPanel').classList.contains('hidden')) return;
      const key = e.key;
      if (['1', '2', '3', '4'].includes(key)) {
        const idx = parseInt(key, 10) - 1;
        const btns = Array.from(document.querySelectorAll('#choices .choice'));
        if (btns[idx] && !btns[idx].disabled) btns[idx].click();
      }
    });
  </script>
</body>

</html>